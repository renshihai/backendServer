<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>埋点事件浏览 - 后台管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .event-row {
            cursor: pointer;
        }
        .event-row:hover {
            background-color: #f8f9fa;
        }
        .event-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .event-details.show {
            max-height: 500px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .export-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .export-loading-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> 埋点事件分析系统
            </a>
        </div>
    </nav>

    <!-- 导出加载模态框 -->
    <div class="export-loading" id="export-loading">
        <div class="export-loading-content">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p id="export-loading-message">正在导出数据...</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- 统计卡片 -->
        <div class="row mb-4" id="stats-cards">
            <div class="col-md-3">
                <div class="card stats-card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="total-events">0</h4>
                                <p>总事件数</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-bar fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="unique-users">0</h4>
                                <p>活跃用户</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="unique-pages">0</h4>
                                <p>页面数量</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="event-types">0</h4>
                                <p>事件类型</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tags fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筛选表单 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> 筛选条件
                </h5>
            </div>
            <div class="card-body">
                <form id="filter-form">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="user_id" class="form-label">用户ID</label>
                            <select class="form-select" id="user_id" name="user_id">
                                <option value="">所有用户</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="event_type" class="form-label">事件类型</label>
                            <input type="text" class="form-control" id="event_type" name="event_type" placeholder="例如: click">
                        </div>
                        <div class="col-md-3">
                            <label for="event_name" class="form-label">事件名称</label>
                            <input type="text" class="form-control" id="event_name" name="event_name" placeholder="例如: button_click">
                        </div>
                        <div class="col-md-3">
                            <label for="page_url" class="form-label">页面URL</label>
                            <input type="text" class="form-control" id="page_url" name="page_url" placeholder="例如: /home">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="start_date" name="start_date">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                        </div>
                        <div class="col-md-3">
                            <label for="sort_by" class="form-label">排序字段</label>
                            <select class="form-select" id="sort_by" name="sort_by">
                                <option value="created_at">创建时间</option>
                                <option value="page_url">页面URL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sort_order" class="form-label">排序方式</label>
                            <select class="form-select" id="sort_order" name="sort_order">
                                <option value="desc">降序</option>
                                <option value="asc">升序</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                            <button type="button" id="reset-btn" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> 重置
                            </button>

                            <!-- 导出功能下拉菜单 -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-download"></i> 导出数据
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportData('csv')">导出为 CSV</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportData('excel')">导出为 Excel</a></li>
                                </ul>
                            </div>

                            <!-- 批量操作下拉菜单 -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog"></i> 批量操作
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="selectAllEvents()">全选当前页</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deselectAllEvents()">取消全选</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="batchDeleteEvents()">删除选中事件</a></li>
                                </ul>
                            </div>

                            <!-- 选中计数 -->
                            <span id="selected-count" class="ms-2 badge bg-info">已选择 0 个事件</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 事件表格 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> 事件列表
                </h5>
                <div class="d-flex align-items-center">
                    <span class="me-2" id="table-info">显示 0 条记录</span>
                    <select class="form-select form-select-sm" id="per-page" style="width: auto;">
                        <option value="20">20条/页</option>
                        <option value="50" selected>50条/页</option>
                        <option value="100">100条/页</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载数据...</p>
                </div>

                <!-- 错误消息显示 -->
                <div id="error-message" class="alert alert-danger" style="display: none;"></div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                                </th>
                                <th>ID</th>
                                <th>用户ID</th>
                                <th>事件类型</th>
                                <th>事件名称</th>
                                <th>页面URL</th>
                                <th>元素ID</th>
                                <th>IP地址</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="events-table-body">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页链接将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 事件详情模态框 -->
    <div class="modal fade" id="eventDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">事件详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="event-detail-content">
                    <!-- 详情内容将通过JavaScript动态填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentPage = 1;
        let currentFilters = {};
        let authToken = localStorage.getItem('authToken');
        let selectedEvents = new Set();

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            if (!authToken) {
                alert('请先登录系统');
                window.location.href = '/login'; // 重定向到登录页
                return;
            }

            // 初始化页面
            loadUsers();
            loadStats();
            loadEvents();

            // 绑定事件
            document.getElementById('filter-form').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 1;
                loadEvents();
            });

            document.getElementById('reset-btn').addEventListener('click', function() {
                document.getElementById('filter-form').reset();
                currentPage = 1;
                currentFilters = {};
                selectedEvents.clear();
                updateSelectedCount();
                loadEvents();
            });

            document.getElementById('per-page').addEventListener('change', function() {
                currentPage = 1;
                loadEvents();
            });
        });

        // 加载用户列表
        function loadUsers() {
            fetch('/api/admin/users', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const userSelect = document.getElementById('user_id');
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (ID: ${user.id})`;
                    userSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('加载用户列表失败:', error);
            });
        }

        // 加载统计信息
        function loadStats() {
            fetch('/api/admin/stats', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                // 更新统计卡片
<!--
                document.getElementById('total-events').textContent = data.total_events || 0;
                document.getElementById('unique-users').textContent = data.total_users || 0;
                document.getElementById('unique-pages').textContent = data.unique_pages || 0;
                document.getElementById('event-types').textContent = data.event_type_stats?.length || 0;
-->
                document.getElementById('total-events').textContent = data.recent_activity.reduce((sum, day) => sum + day.count, 0);
                document.getElementById('unique-users').textContent = data.user_stats.length;
                document.getElementById('unique-pages').textContent = data.page_stats.length;
                document.getElementById('event-types').textContent = data.type_stats.length;

            })
            .catch(error => {
                console.error('加载统计信息失败:', error);
            });
        }

        // 加载事件数据
        function loadEvents() {
            showLoading(true);
            hideError();

            // 构建查询参数
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();

            // 添加筛选参数
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }

            // 添加分页参数
            params.append('page', currentPage);
            params.append('per_page', document.getElementById('per-page').value);

            // 保存当前筛选条件
            currentFilters = Object.fromEntries(params);

            fetch(`/api/admin/events?${params}`)
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                renderEventsTable(data);
                renderPagination(data);
            })
            .catch(error => {
                showLoading(false);
                console.error('加载事件数据失败:', error);
                showError('加载数据失败，请检查网络连接或重新登录');
            });
        }

        // 渲染事件表格
        function renderEventsTable(data) {
            const tbody = document.getElementById('events-table-body');
            tbody.innerHTML = '';

            if (data.events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>没有找到匹配的事件记录</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.events.forEach(event => {
                const row = document.createElement('tr');
                row.className = 'event-row';
                const isChecked = selectedEvents.has(event.id);

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="event-checkbox" value="${event.id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleEventSelection(this, ${event.id})">
                    </td>
                    <td>${event.id}</td>
                    <td>${event.user_id}</td>
                    <td><span class="badge bg-primary">${event.event_type}</span></td>
                    <td>${event.event_name}</td>
                    <td>${event.page_url || '-'}</td>
                    <td>${event.element_id || '-'}</td>
                    <td>${event.ip_address || '-'}</td>
                    <td>${new Date(event.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showEventDetail(${event.id})">
                            <i class="fas fa-eye"></i> 详情
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSingleEvent(${event.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新表格信息
            document.getElementById('table-info').textContent =
                `显示 ${data.events.length} 条记录，共 ${data.total} 条`;

            // 更新全选复选框状态
            const allChecked = data.events.length > 0 && data.events.every(event => selectedEvents.has(event.id));
            document.getElementById('select-all').checked = allChecked;
        }

        // 渲染分页
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (data.pages <= 1) return;

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            `;
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= data.pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === data.pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // 切换页面
        function changePage(page) {
            currentPage = page;
            loadEvents();
        }

        // 显示事件详情
        function showEventDetail(eventId) {
            fetch(`/api/admin/events?user_id=&event_type=&event_name=&page_url=&start_date=&end_date=&sort_by=created_at&sort_order=desc&page=1&per_page=1000`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const event = data.events.find(e => e.id === eventId);
                if (event) {
                    const modalContent = document.getElementById('event-detail-content');
                    modalContent.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基本信息</h6>
                                <table class="table table-sm">
                                    <tr><th>事件ID</th><td>${event.id}</td></tr>
                                    <tr><th>用户ID</th><td>${event.user_id}</td></tr>
                                    <tr><th>事件类型</th><td>${event.event_type}</td></tr>
                                    <tr><th>事件名称</th><td>${event.event_name}</td></tr>
                                    <tr><th>页面URL</th><td>${event.page_url || '-'}</td></tr>
                                    <tr><th>元素ID</th><td>${event.element_id || '-'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>其他信息</h6>
                                <table class="table table-sm">
                                    <tr><th>IP地址</th><td>${event.ip_address || '-'}</td></tr>
                                    <tr><th>User Agent</th><td><small>${event.user_agent || '-'}</small></td></tr>
                                    <tr><th>创建时间</th><td>${new Date(event.created_at).toLocaleString()}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>事件数据</h6>
                                <pre class="bg-light p-3"><code>${JSON.stringify(event.event_data, null, 2)}</code></pre>
                            </div>
                        </div>
                    `;

                    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
                    modal.show();
                }
            })
            .catch(error => {
                console.error('获取事件详情失败:', error);
                alert('获取事件详情失败');
            });
        }


        function getFilenameFromContentDisposition(contentDisposition) {
            if (!contentDisposition) return null;

            // 尝试匹配 filename* 格式
            let filenameMatch = contentDisposition.match(/filename\*=(?:UTF-8|utf-8)''([^;]+)/i);
            if (filenameMatch && filenameMatch[1]) {
                return decodeURIComponent(filenameMatch[1]);
            }

            // 尝试匹配 filename 格式
            filenameMatch = contentDisposition.match(/filename="?([^";]+)"?/i);
            if (filenameMatch && filenameMatch[1]) {
                // 如果文件名被引号包围，则去掉引号
                return filenameMatch[1].replace(/"/g, '');
            }

            return null;
        }
        // 导出数据
        function exportData(format) {
            // 构建查询参数
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();

            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }
            params.append('format', format);

            const exportUrl = `/api/admin/events/export?${params}`;

            // 显示导出提示
            showExportLoading(true, `正在导出${format.toUpperCase()}数据...`);

            // 使用 XMLHttpRequest 来精确控制下载过程
            const xhr = new XMLHttpRequest();
            xhr.open('GET', exportUrl, true);
            xhr.responseType = 'blob'; // 重要：指定响应类型为 blob

            xhr.onload = function() {
                // 请求完成，隐藏导出提示
                showExportLoading(false);

                if (xhr.status === 200) {
                    // 创建 blob 链接并触发下载
                    const blob = new Blob([xhr.response], {
                        type: xhr.getResponseHeader('Content-Type')
                    });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    // 从响应头获取文件名
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = `events_export.${format}`;
                    const parsedFilename = getFilenameFromContentDisposition(contentDisposition);
                    if (parsedFilename) {
                        filename = parsedFilename;
                    }

                    a.download = filename;

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showSuccess(`数据已成功导出为${format.toUpperCase()}格式`);
                } else {
                    // 处理错误
                    const reader = new FileReader();
                    reader.onload = function() {
                        try {
                            const errorData = JSON.parse(reader.result);
                            showError('导出失败: ' + (errorData.error || errorData.details || '未知错误'));
                        } catch (e) {
                            showError('导出失败: 服务器返回错误，状态码 ' + xhr.status);
                        }
                    };
                    reader.readAsText(xhr.response);
                }
            };

            xhr.onerror = function() {
                showExportLoading(false);
                showError('导出失败: 网络错误');
            };

            // 可选：显示下载进度
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    showExportLoading(true, `正在导出${format.toUpperCase()}数据... ${percentComplete.toFixed(1)}%`);
                }
            };

            xhr.send();
        }

        // 显示/隐藏导出加载状态
        function showExportLoading(show, message = '') {
            const loadingElement = document.getElementById('export-loading');
            const messageElement = document.getElementById('export-loading-message');

            if (show) {
                messageElement.textContent = message;
                loadingElement.style.display = 'flex';
            } else {
                loadingElement.style.display = 'none';
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>成功!</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // 插入到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            // 5秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 显示错误消息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // 隐藏错误消息
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        // 全选/取消全选
        function toggleSelectAll(checkbox) {
            const eventCheckboxes = document.querySelectorAll('.event-checkbox');
            eventCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const eventId = parseInt(cb.value);
                if (checkbox.checked) {
                    selectedEvents.add(eventId);
                } else {
                    selectedEvents.delete(eventId);
                }
            });
            updateSelectedCount();
        }

        // 选择单个事件
        function toggleEventSelection(checkbox, eventId) {
            if (checkbox.checked) {
                selectedEvents.add(eventId);
            } else {
                selectedEvents.delete(eventId);
                // 如果取消单个选择，也取消全选状态
                document.getElementById('select-all').checked = false;
            }
            updateSelectedCount();
        }

        // 更新选中计数
        function updateSelectedCount() {
            const selectedCount = document.getElementById('selected-count');
            if (selectedCount) {
                selectedCount.textContent = `已选择 ${selectedEvents.size} 个事件`;
            }
        }

        // 全选当前页
        function selectAllEvents() {
            const eventCheckboxes = document.querySelectorAll('.event-checkbox');
            eventCheckboxes.forEach(cb => {
                cb.checked = true;
                selectedEvents.add(parseInt(cb.value));
            });
            document.getElementById('select-all').checked = true;
            updateSelectedCount();
            showSuccess(`已选择当前页 ${eventCheckboxes.length} 个事件`);
        }

        // 取消全选
        function deselectAllEvents() {
            const eventCheckboxes = document.querySelectorAll('.event-checkbox');
            eventCheckboxes.forEach(cb => {
                cb.checked = false;
                selectedEvents.delete(parseInt(cb.value));
            });
            document.getElementById('select-all').checked = false;
            updateSelectedCount();
            showSuccess('已取消所有选择');
        }

        // 批量删除事件
        function batchDeleteEvents() {
            if (selectedEvents.size === 0) {
                showError('请先选择要删除的事件');
                return;
            }

            if (!confirm(`确定要删除选中的 ${selectedEvents.size} 个事件吗？此操作不可恢复！`)) {
                return;
            }

            showExportLoading(true, '正在删除选中事件...');

            fetch('/api/admin/events/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    event_ids: Array.from(selectedEvents)
                })
            })
            .then(response => response.json())
            .then(data => {
                showExportLoading(false);
                if (data.error) {
                    showError('删除失败: ' + data.error);
                } else {
                    showSuccess(data.message);
                    // 清空选择集
                    selectedEvents.clear();
                    updateSelectedCount();
                    // 重新加载事件列表
                    loadEvents();
                    // 重新加载统计
                    loadStats();
                }
            })
            .catch(error => {
                showExportLoading(false);
                showError('删除失败: ' + error.message);
            });
        }

        // 删除单个事件
        function deleteSingleEvent(eventId) {
            if (!confirm('确定要删除这个事件吗？此操作不可恢复！')) {
                return;
            }

            showExportLoading(true, '正在删除事件...');

            fetch(`/api/admin/events/batch`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    event_ids: [eventId]
                })
            })
            .then(response => response.json())
            .then(data => {
                showExportLoading(false);
                if (data.error) {
                    showError('删除失败: ' + data.error);
                } else {
                    showSuccess(data.message);
                    // 从选择集中移除
                    selectedEvents.delete(eventId);
                    updateSelectedCount();
                    // 重新加载事件列表
                    loadEvents();
                    // 重新加载统计
                    loadStats();
                }
            })
            .catch(error => {
                showExportLoading(false);
                showError('删除失败: ' + error.message);
            });
        }

        // 显示/隐藏加载动画
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>